\section{Rectilinear movement with $r_{flywheel}$ free}
In this section we have developed the Lagrange Mechanics for the system with
one mass of the flywheel beeing free.

The generalized coordinates ($q$) will be:
\begin{enumerate}
	\item $\phi_{ground-wheel}$: rotation of the wheel respect the ground.
	\item $\phi_{wheel-platform}$: rotation of the platform respect the wheel.
	\item $\phi_{platform-flywheel}$: rotation of the flywheel respect the platform.
	\item $r$: distance from the center of the flywheel to the free cylinder.

\end{enumerate}

We will use two auxiliary variables:
\begin{enumerate}
	\item $\phi_{ground-platform}=\phi_{ground-wheel}+\phi_{wheel-platform}$: rotation of the platform respect the ground.
	\item $\phi_{ground-flywheel}=\phi_{ground-platform}+\phi_{platform-flywheel}$: rotation of the flywheel respect the ground.
\end{enumerate}

The total potential energy:
\begin{equation}
	V = m_{cylinder}\cdot (r-r_{flywheel-max}) \cdot cos(\phi_{ground-flywheel}) \cdot g
\end{equation}


The total kinetic energy:
\begin{multline}
	T = \frac{1}{2}\cdot[\dot{\phi}_{ground-wheel}^2\cdot I_{wheel}
		+ \dot{\phi}_{ground-platform}^2 \cdot I_{platform}
		+ \dot{\phi}_{ground-flywheel}^2\cdot I_{flywheel}(r)\\
		+ \dot{\phi}_{ground-wheel}^2\cdot r_{wheel}^2\cdot m_{total}
		+ \dot{r}^2\cdot m_{cylinder}]
\end{multline}

The Lagrangian is defined as:
\begin{equation}
	L=T-V
\end{equation}

Lagrange's equation is:
\begin{equation}
	\frac{d}{dt}(\frac{\partial L}{\partial \dot{q}_j})=
	\frac{\partial L}{\partial q_j}	+ F_{j}
\end{equation}

So in our case:
\begin{multline}
	\frac{\partial L}{\partial \dot{\phi}_{ground-wheel}}=
	\dot{\phi}_{ground-wheel} \cdot I_{wheel}
	+ \dot{\phi}_{ground-platform} \cdot I_{platform}\\
	+ \dot{\phi}_{ground-flywheel}\cdot I_{flywheel}(r)
	+ \dot{\phi}_{ground-wheel}\cdot r_{wheel}^2\cdot m_{total}
\end{multline}

\begin{equation}
	\frac{\partial L}{\partial \dot{\phi}_{wheel-platform}}=
	\dot{\phi}_{ground-platform} \cdot I_{platform}
	+ \dot{\phi}_{ground-flywheel}\cdot I_{flywheel}(r)
\end{equation}

\begin{equation}
	\frac{\partial L}{\partial \dot{\phi}_{platform-flywheel}}=
	\dot{\phi}_{ground-flywheel}\cdot I_{flywheel}(r)
\end{equation}

\begin{equation}
	\frac{\partial L}{\partial \dot{r}}=
	\dot{r}\cdot m_{cylinder}
\end{equation}

We define M as the following matrix:
\begin{equation}
	\begin{pmatrix}
		I_{wheel} + I_{platform} + I_{flywheel}(r) + r_{wheel}^2 \cdot m_{total} &
		I_{platform} + I_{flywheel}(r)                                           &
		I_{flywheel}(r)                                                          &
		0                                                                          \\
		I_{platform} + I_{flywheel}(r)                                           &
		I_{platform} + I_{flywheel}(r)                                           &
		I_{flywheel}(r)                                                          &
		0                                                                          \\
		I_{flywheel}(r)                                                          &
		I_{flywheel}(r)                                                          &
		I_{flywheel}(r)                                                          &
		0                                                                          \\
		0                                                                        &
		0                                                                        &
		0                                                                        &
		m_{cylinder}                                                               \\
	\end{pmatrix}
\end{equation}

In matrix form and with our generalized coordinates:
\begin{equation}
	\frac{\partial L}{\partial \dot{q}} =
	M \cdot \dot{q}
\end{equation}

\begin{equation}
	\frac{d}{dt}(\frac{\partial L}{\partial \dot{q}}) =
	M \cdot \ddot{q} + \dot{M} \cdot \dot{q}
\end{equation}

Let's recall the definition of $I_{flywheel}(r)$
\begin{equation}
	I_{flywheel}(r)= m_{cylinder} \cdot r^2 + C
\end{equation}


Compute the derivative
\begin{equation}
	\dot{I}_{flywheel}(r)= 2 \cdot m_{cylinder} \cdot r \cdot \dot{r}
\end{equation}

We compute $\dot{M}$ as the following matrix:
\begin{equation}
	\dot{M}=
	\dot{I}_{flywheel}(r) \cdot
	\begin{pmatrix}
		1 &
		1 &
		1 &
		0   \\
		1 &
		1 &
		1 &
		0   \\
		1 &
		1 &
		1 &
		0   \\
		0 &
		0 &
		0 &
		0   \\
	\end{pmatrix}
\end{equation}

Let $a$ be::
\begin{equation}
	\frac{\partial L}{\partial q_{1..3}} = a = m_{cylinder}\cdot (r-r_{flywheel-max}) \cdot g \cdot sin(\phi_{ground-flywheel})
\end{equation}

Let $b$ be:
\begin{equation}
	\frac{\partial L}{\partial r} = b = \cdot m_{cylinder} \cdot r  \cdot \dot{\phi}_{ground-flywheel}^2  - m_{cylinder}\cdot g \cdot cos(\phi_{ground-flywheel})
\end{equation}

\begin{equation}
	\frac{\partial L}{\partial q} = \begin{pmatrix}
		a \\ a \\ a \\ b
	\end{pmatrix}
\end{equation}

So using Lagrange's equation we get:
\begin{equation}
	\boxed{
		M \cdot \ddot{q} + \dot{M} \cdot \dot{q}=
		\begin{pmatrix}
			a \\ a \\ a \\ b
		\end{pmatrix}
		+ F
	}
\end{equation}
